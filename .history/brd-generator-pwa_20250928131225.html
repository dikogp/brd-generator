<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aplikasi Pembuat BRD</title>
    <link href="./dist/output.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <meta name="theme-color" content="#1f2937" />
    <link
      rel="apple-touch-icon"
      href="https://img.icons8.com/fluency/96/task.png"
    />
    <link rel="icon" href="https://img.icons8.com/fluency/48/task.png" />

    <style>
      /* Theme variables */
      :root {
        /* Default/Dark Theme */
        --primary-color: #3b82f6;
        --secondary-color: #1f2937;
        --background-color: #111827;
        --text-color: #e5e7eb;
        --card-color: #1f2937;
        --border-color: #4b5563;
        --hover-color: rgba(59, 130, 246, 0.1);
      }

      /* Light Theme */
      .theme-light {
        --primary-color: #2563eb;
        --secondary-color: #f3f4f6;
        --background-color: #ffffff;
        --text-color: #111827;
        --card-color: #f9fafb;
        --border-color: #e5e7eb;
        --hover-color: rgba(37, 99, 235, 0.1);
      }

      /* Blue Theme */
      .theme-blue {
        --primary-color: #06b6d4;
        --secondary-color: #0f172a;
        --background-color: #0c4a6e;
        --text-color: #f0f9ff;
        --card-color: #1e3a8a;
        --border-color: #1e40af;
        --hover-color: rgba(6, 182, 212, 0.2);
      }

      html {
        scroll-behavior: smooth;
      }
      body {
        background-color: var(--background-color);
        color: var(--text-color);
        font-family: "Inter", sans-serif;
      }
      .sidebar-link {
        transition: all 0.2s ease-in-out;
        border-left: 3px solid transparent;
        cursor: pointer;
      }
      .sidebar-link:hover,
      .sidebar-link.active {
        background-color: rgba(59, 130, 246, 0.1);
        color: var(--primary-color);
        border-left-color: var(--primary-color);
      }
      textarea,
      input,
      select {
        background-color: #374151;
        border-color: var(--border-color);
        color: var(--text-color);
      }
      input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(1);
      }
      textarea:focus,
      input:focus,
      select:focus {
        border-color: var(--primary-color);
        --tw-ring-color: var(--primary-color);
        --tw-ring-shadow: var(--tw-ring-inset) 0 0 0
          calc(1px + var(--tw-ring-offset-width)) var(--tw-ring-color);
      }
      .form-section {
        padding-top: 1rem;
      }
      .toast {
        position: fixed;
        bottom: 1.5rem;
        right: 1.5rem;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        color: white;
        font-weight: 500;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
        z-index: 10000;
        animation: fadeInOut 4s ease-in-out forwards;
      }
      .toast-success {
        background-color: #22c55e;
      }
      .toast-error {
        background-color: #ef4444;
      }
      @keyframes fadeInOut {
        0%,
        100% {
          opacity: 0;
          transform: translateY(20px);
        }
        10%,
        90% {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .invalid-field {
        border-color: #ef4444 !important;
        --tw-ring-color: #ef4444 !important;
      }
      .main-menu-card {
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .main-menu-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.2),
          0 4px 6px -2px rgba(59, 130, 246, 0.1);
      }
      .brd-list-item:hover {
        background-color: #374151;
      }
      .prose h1,
      .prose h2,
      .prose h3 {
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.3em;
        margin-top: 1.5em;
        margin-bottom: 1em;
      }
      .prose ul {
        list-style-type: disc;
        padding-left: 1.5em;
      }
      .prose ol {
        list-style-type: decimal;
        padding-left: 1.5em;
      }
      .prose table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1em;
      }
      .prose th,
      .prose td {
        border: 1px solid var(--border-color);
        padding: 8px;
        text-align: left;
      }
      .prose th {
        background-color: #374151;
      }
      .prose p {
        margin-top: 0.5em;
        margin-bottom: 0.5em;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      /* Header and auth menu styles */
      header {
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .auth-button {
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        font-weight: 500;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
      }

      .auth-button.login {
        background-color: var(--primary-color);
        color: white;
      }

      .auth-button.login:hover {
        background-color: #2563eb;
      }

      .auth-button.register {
        border: 1px solid var(--primary-color);
        color: var(--primary-color);
        margin-right: 0.75rem;
      }

      .auth-button.register:hover {
        background-color: rgba(59, 130, 246, 0.1);
      }

      .user-menu {
        position: relative;
      }

      .user-menu-dropdown {
        position: absolute;
        top: calc(100% + 0.5rem);
        right: 0;
        width: 240px;
        background-color: var(--card-color);
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
        z-index: 50;
        overflow: hidden;
        display: none;
      }

      .user-menu.active .user-menu-dropdown {
        display: block;
      }

      .dropdown-item {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        color: var(--text-color);
        transition: background-color 0.2s;
      }

      .dropdown-item:hover {
        background-color: rgba(59, 130, 246, 0.1);
      }

      .dropdown-item svg {
        margin-right: 0.5rem;
        width: 1.25rem;
        height: 1.25rem;
      }

      .dropdown-divider {
        height: 1px;
        background-color: var(--border-color);
      }

      .user-info-container {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        text-align: center;
      }

      .user-avatar {
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        margin: 0 auto 0.5rem;
        border: 2px solid var(--primary-color);
      }

      /* Adjust main menu margin top */
      #main-menu {
        padding-top: 1.5rem;
      }

      /* Modal Animation */
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideIn {
        from {
          transform: translateY(-20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      #auth-modal {
        animation: fadeIn 0.3s ease-out;
      }

      #auth-modal > div:last-child {
        animation: slideIn 0.3s ease-out;
      }
    </style>
  </head>
  <body class="antialiased">
    <!-- Header Bar yang lebih profesional -->
    <header class="bg-gray-800 shadow-md border-b border-gray-700 z-50">
      <div
        class="container mx-auto px-4 py-2.5 flex items-center justify-between"
      >
        <div class="flex items-center">
          <img
            src="https://img.icons8.com/fluency/48/task.png"
            alt="Logo BRD Generator"
            class="h-8 w-8 mr-2"
          />
          <h1 class="text-xl font-bold text-white">BRD Generator</h1>
        </div>

        <!-- Auth Menu yang lebih rapi -->
        <div id="header-auth-container" class="flex items-center">
          <!-- Placeholder untuk autentikasi -->
        </div>
      </div>
    </header>

    <!-- Main Menu Page -->
    <div
      id="main-menu"
      class="flex flex-col items-center justify-center min-h-screen p-4"
    >
      <div class="text-center mb-12">
        <img
          src="https://img.icons8.com/fluency/96/task.png"
          alt="Logo Aplikasi BRD"
          class="h-20 w-20 mx-auto mb-4"
        />
        <h1 class="text-4xl font-bold text-white">BRD Generator</h1>
        <p class="text-gray-400 mt-2">
          Selamat datang! Kelola semua dokumen kebutuhan bisnis Anda di sini.
        </p>
      </div>
      <div
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 w-full max-w-6xl"
      >
        <div
          id="btn-new-brd"
          class="main-menu-card bg-gray-800 p-6 rounded-lg text-center cursor-pointer border border-gray-700"
        >
          <h2 class="text-xl font-semibold text-blue-400">Buat BRD Baru</h2>
          <p class="text-gray-400 mt-2 text-sm">
            Mulai dari awal dengan form kosong.
          </p>
        </div>
        <div
          id="btn-edit-brd"
          class="main-menu-card bg-gray-800 p-6 rounded-lg text-center cursor-pointer border border-gray-700"
        >
          <h2 class="text-xl font-semibold text-blue-400">Edit BRD</h2>
          <p class="text-gray-400 mt-2 text-sm">
            Lanjutkan atau ubah BRD yang sudah ada.
          </p>
        </div>
        <div
          id="btn-preview-brd"
          class="main-menu-card bg-gray-800 p-6 rounded-lg text-center cursor-pointer border border-gray-700"
        >
          <h2 class="text-xl font-semibold text-blue-400">Preview BRD</h2>
          <p class="text-gray-400 mt-2 text-sm">
            Lihat & unduh BRD yang telah selesai.
          </p>
        </div>
        <div
          id="btn-settings"
          class="main-menu-card bg-gray-800 p-6 rounded-lg text-center cursor-pointer border border-gray-700"
        >
          <h2 class="text-xl font-semibold text-blue-400">Pengaturan</h2>
          <p class="text-gray-400 mt-2 text-sm">Atur preferensi aplikasi.</p>
        </div>
      </div>
    </div>

    <!-- BRD List Page (for Edit/Preview) -->
    <div id="brd-list-page" class="hidden p-4 md:p-10">
      <button
        id="btn-back-to-menu"
        class="mb-8 text-blue-400 hover:text-blue-300"
      >
        &larr; Kembali ke Menu
      </button>
      <h1 id="brd-list-title" class="text-3xl font-bold mb-6"></h1>
      <div
        id="brd-list-container"
        class="bg-gray-800 rounded-lg p-6 border border-gray-700"
      >
        <!-- List will be populated by JS -->
      </div>
    </div>

    <!-- BRD Preview Page -->
    <div id="brd-preview-page" class="hidden p-4 md:p-10">
      <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-8">
          <button
            id="btn-back-to-list"
            class="text-blue-400 hover:text-blue-300"
          >
            &larr; Kembali ke Daftar BRD
          </button>
          <button
            id="btn-download-pdf"
            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition-colors flex items-center"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 mr-2"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                clip-rule="evenodd"
              />
            </svg>
            Unduh PDF
          </button>
        </div>
        <div
          id="preview-content"
          class="bg-gray-800 rounded-lg p-8 border border-gray-700 prose max-w-4xl mx-auto"
        >
          <!-- Preview content will be populated here -->
        </div>
      </div>
    </div>

    <!-- Wizard/Form Page -->
    <div
      id="wizard-container"
      class="hidden h-screen bg-gray-900 text-gray-200 flex"
    >
      <aside class="w-64 flex-shrink-0 bg-gray-800 p-4 flex flex-col">
        <div class="flex items-center mb-2">
          <img
            src="https://img.icons8.com/fluency/48/task.png"
            alt="Logo Aplikasi BRD"
            class="h-8 w-8 mr-2"
          />
          <h1 class="text-xl font-bold">BRD Generator</h1>
        </div>
        <button
          id="btn-home-from-wizard"
          class="text-xs text-blue-400 hover:text-blue-300 mb-4 text-left"
        >
          &larr; Kembali ke Menu Utama
        </button>
        <nav id="sidebar-nav" class="flex flex-col space-y-1 flex-grow"></nav>

        <!-- Add this inside the sidebar in the wizard container -->
        <div class="mt-auto border-t border-gray-700 pt-4 mb-4">
          <div id="sidebar-user-area" class="text-sm text-gray-400">
            <!-- Will be populated by JS -->
          </div>
        </div>
      </aside>
      <main class="flex-1 p-6 md:p-8 lg:p-10 overflow-y-auto flex flex-col">
        <div id="brd-form-container" class="max-w-4xl mx-auto w-full flex-grow">
          <h1 class="text-3xl font-bold text-white mb-2">
            Business Requirement Document (BRD)
          </h1>
          <p class="text-gray-400 mb-8">
            Isi form di bawah ini untuk membuat dokumen kebutuhan bisnis Anda.
          </p>
          <div id="brd-form" class="mt-8"></div>
        </div>
        <div
          id="navigation-buttons"
          class="max-w-4xl mx-auto mt-6 flex justify-between w-full"
        >
          <button
            id="prevBtn"
            class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded transition-colors"
          >
            Sebelumnya
          </button>
          <button
            id="nextBtn"
            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors"
          >
            Selanjutnya
          </button>
        </div>
      </main>
    </div>

    <!-- Settings Page -->
    <div id="settings-page" class="hidden p-4 md:p-10">
      <button
        id="btn-back-from-settings"
        class="mb-8 text-blue-400 hover:text-blue-300"
      >
        &larr; Kembali ke Menu
      </button>

      <h1 class="text-3xl font-bold mb-8">Pengaturan</h1>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Theme Settings -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
          <h2 class="text-xl font-semibold text-blue-400 mb-4">
            Tema Aplikasi
          </h2>
          <p class="text-gray-400 mb-4">
            Pilih tema tampilan aplikasi sesuai preferensi Anda.
          </p>

          <div class="flex flex-col space-y-3">
            <label class="flex items-center cursor-pointer">
              <input
                type="radio"
                name="theme"
                value="default"
                class="mr-2 accent-blue-500"
                checked
              />
              <span>Tema Default (Gelap)</span>
            </label>
            <label class="flex items-center cursor-pointer">
              <input
                type="radio"
                name="theme"
                value="light"
                class="mr-2 accent-blue-500"
              />
              <span>Tema Terang</span>
            </label>
            <label class="flex items-center cursor-pointer">
              <input
                type="radio"
                name="theme"
                value="blue"
                class="mr-2 accent-blue-500"
              />
              <span>Tema Biru</span>
            </label>
          </div>

          <button
            id="btn-save-theme"
            class="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
          >
            Simpan Tema
          </button>
        </div>

        <!-- Account Settings -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
          <h2 class="text-xl font-semibold text-blue-400 mb-4">
            Pengaturan Akun
          </h2>
          <!-- Add this to the account-not-logged-in div -->
          <div class="bg-blue-900 text-white p-3 rounded-md mt-3 text-sm">
            <strong>Info untuk Developer:</strong>
            <p class="mt-1">
              Jika melihat error "configuration-not-found", lakukan langkah
              berikut di
              <a
                href="https://console.firebase.google.com"
                class="text-blue-300 underline"
                target="_blank"
                >Firebase Console</a
              >:
            </p>
            <ol class="list-decimal pl-5 mt-1">
              <li>Buka project "brd-generator-app-ce7a5"</li>
              <li>Pilih "Authentication" → "Sign-in method"</li>
              <li>Aktifkan provider "Google"</li>
              <li>Tambahkan domain aplikasi di "Authorized domains"</li>
            </ol>
          </div>
          <!-- Not logged in view -->
          <div id="account-not-logged-in">
            <p class="text-gray-400 mb-4">
              Masuk untuk menyimpan BRD ke akun Anda dan akses dari perangkat
              mana saja.
            </p>

            <div class="flex flex-col space-y-3">
              <button
                id="btn-google-login"
                class="flex items-center justify-center bg-white hover:bg-gray-100 text-gray-800 font-bold py-2 px-4 rounded"
              >
                <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24">
                  <path
                    fill="#4285F4"
                    d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                  />
                  <path
                    fill="#34A853"
                    d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                  />
                  <path
                    fill="#FBBC05"
                    d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                  />
                  <path
                    fill="#EA4335"
                    d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                  />
                </svg>
                Masuk dengan Google
              </button>
              <button
                id="btn-guest-login"
                class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded"
              >
                Lanjutkan sebagai Tamu
              </button>
            </div>
          </div>

          <!-- Logged in view -->
          <div id="account-logged-in" class="hidden">
            <div class="flex items-center mb-4">
              <img
                id="user-avatar"
                src=""
                alt="Profile Picture"
                class="w-12 h-12 rounded-full mr-4"
              />
              <div>
                <h3 id="user-display-name" class="font-medium"></h3>
                <p id="user-email" class="text-gray-400 text-sm"></p>
              </div>
            </div>

            <div class="border-t border-gray-700 pt-4 mt-4">
              <p class="text-gray-400 mb-4">Opsi akun:</p>
              <button
                id="btn-logout"
                class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded"
              >
                Keluar
              </button>
            </div>
          </div>

          <!-- Guest mode view -->
          <div id="account-guest-mode" class="hidden">
            <div class="flex items-center mb-4">
              <div
                class="w-12 h-12 rounded-full bg-gray-600 flex items-center justify-center mr-4"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-6 w-6 text-gray-300"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                  />
                </svg>
              </div>
              <div>
                <h3 class="font-medium">Mode Tamu</h3>
                <p class="text-gray-400 text-sm">
                  Data hanya tersimpan di perangkat ini
                </p>
              </div>
            </div>

            <div class="border-t border-gray-700 pt-4 mt-4">
              <p class="text-gray-400 mb-4">
                Ingin menyimpan data di cloud? Masuk dengan akun:
              </p>
              <button
                id="btn-switch-to-account"
                class="flex items-center justify-center bg-white hover:bg-gray-100 text-gray-800 font-bold py-2 px-4 rounded"
              >
                <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24">
                  <path
                    fill="#4285F4"
                    d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                  />
                  <path
                    fill="#34A853"
                    d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                  />
                  <path
                    fill="#FBBC05"
                    d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                  />
                  <path
                    fill="#EA4335"
                    d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                  />
                </svg>
                Masuk dengan Google
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>

    <!-- Firebase Initialization -->
    <script src="./firebase-init.js"></script>

    <script>
      // Initialize Firebase after the SDK is loaded
      document.addEventListener("DOMContentLoaded", function () {
        if (typeof initializeFirebase === "function") {
          initializeFirebase();
        }
      });
    </script>
    <script>
      // Check if Firebase is properly initialized from the external file
      let firebaseInitialized = false;

      document.addEventListener("DOMContentLoaded", function () {
        // Check if Firebase was initialized from the external file
        if (typeof firebase !== "undefined" && firebase.app) {
          try {
            // Verify we have a valid Firebase instance
            firebase.app();
            firebaseInitialized = true;
            console.log("Using Firebase from external configuration");

            // If Firebase auth is available, set up the auth state observer
            if (firebase.auth) {
              firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                  currentUser = user;
                  updateUIforLoggedInUser(user);
                } else {
                  currentUser = null;
                  updateUIforLoggedOutUser();
                }
              });
            }
          } catch (error) {
            console.error("Error verifying Firebase:", error);
          }
        } else {
          console.warn(
            "Firebase not initialized - authentication features will be disabled"
          );
        }

        // Global variables
        let currentStep = 0;
        let currentBRDId = null;
        let formContainer, sidebar, mainContent, wizardContainer, sidebarNav;
        let formSections = [];
        let dynamicListAdders = {};
        let dynamicListsInitialized = false; // ADD: Missing variable

        // User authentication and theme management
        let currentUser = null;
        let currentTheme = localStorage.getItem("theme") || "default";

        // Define dynamic lists configuration - SINGLE DECLARATION
        const singleInputLists = [
          "tujuan-bisnis-list",
          "in-scope-list",
          "out-of-scope-list",
          "fungsional-list",
          "non-fungsional-list",
          "asumsi-list",
        ];

        // Fix the multiInputLists configuration for stakeholders
        const multiInputLists = [
          {
            key: "stakeholders-list",
            selector: ".stakeholders-item", // Fixed: was ".stakeholder-item" (singular)
            fields: ["name", "role", "responsibility"],
          },
          {
            key: "kriteria-keberhasilan-list",
            selector: ".kriteria-keberhasilan-item",
            fields: ["kriteria", "metrik", "target"],
          },
          {
            key: "timeline-list",
            selector: ".timeline-item",
            fields: [
              "fase",
              "durasi",
              "tanggalMulai",
              "tanggalSelesai",
              "aktivitas",
            ],
          },
          {
            key: "biaya-list",
            selector: ".biaya-item",
            fields: ["item", "jumlah", "keterangan"],
          },
          {
            key: "sumber-daya-list",
            selector: ".sumber-daya-item",
            fields: ["peran", "nama", "alokasi"],
          },
          {
            key: "risiko-list",
            selector: ".risiko-item",
            fields: ["risiko", "dampak", "probabilitas", "mitigasi"],
          },
          {
            key: "lampiran-list",
            selector: ".lampiran-item",
            fields: ["nama", "tipe", "deskripsi"],
          },
        ];

        // Form sections definition
        const sections = [
          { id: "info-umum", title: "Informasi Umum" },
          { id: "tujuan-bisnis", title: "Tujuan Bisnis" },
          { id: "ruang-lingkup", title: "Ruang Lingkup" },
          { id: "stakeholders", title: "Stakeholders" },
          { id: "kebutuhan-bisnis", title: "Kebutuhan Bisnis" },
          { id: "kriteria-keberhasilan", title: "Kriteria Keberhasilan" },
          { id: "timeline", title: "Timeline" },
          { id: "biaya-sumber-daya", title: "Biaya & Sumber Daya" },
          { id: "asumsi-risiko", title: "Asumsi & Risiko" },
          { id: "lampiran", title: "Lampiran" },
        ];

        const placeholders = {
          "ringkasan-eksekutif":
            "Tuliskan ringkasan singkat tentang proyek ini...",
          "latar-belakang":
            "Jelaskan kondisi saat ini dan alasan mengapa proyek ini diperlukan...",
        };
        // Header Auth Management
        function updateHeaderAuth() {
          const authContainer = document.getElementById(
            "header-auth-container"
          );
          if (!authContainer) return;

          if (currentUser) {
            // User is logged in
            authContainer.innerHTML = `
      <div class="user-menu" id="user-menu">
        <div class="flex items-center cursor-pointer auth-button" id="user-menu-trigger">
          <img src="${
            currentUser.photoURL ||
            "https://img.icons8.com/fluency/96/user-male-circle.png"
          }" 
               alt="Profile" class="w-8 h-8 rounded-full mr-2 border border-blue-400">
          <span class="mr-2">${
            currentUser.displayName || currentUser.email || "User"
          }</span>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="user-menu-dropdown">
          <div class="user-info-container">
            <img src="${
              currentUser.photoURL ||
              "https://img.icons8.com/fluency/96/user-male-circle.png"
            }" 
                 alt="Profile" class="user-avatar">
            <div class="font-medium">${currentUser.displayName || "User"}</div>
            <div class="text-sm text-gray-500">${currentUser.email || ""}</div>
          </div>
          <a href="#" class="dropdown-item" id="menu-settings">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Pengaturan
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item" id="menu-logout">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" />
            </svg>
            Keluar
          </a>
        </div>
      </div>
    `;

            // Add event listeners
            document
              .getElementById("user-menu-trigger")
              .addEventListener("click", (e) => {
                e.preventDefault();
                document.getElementById("user-menu").classList.toggle("active");
              });

            document
              .getElementById("menu-settings")
              .addEventListener("click", (e) => {
                e.preventDefault();
                showSettings();
              });

            document
              .getElementById("menu-logout")
              .addEventListener("click", (e) => {
                e.preventDefault();
                signOut();
              });

            // Close dropdown when clicking outside
            document.addEventListener("click", (e) => {
              const menu = document.getElementById("user-menu");
              const trigger = document.getElementById("user-menu-trigger");
              if (
                menu &&
                !menu.contains(e.target) &&
                !trigger.contains(e.target)
              ) {
                menu.classList.remove("active");
              }
            });
          } else if (localStorage.getItem("userMode") === "guest") {
            // Guest mode
            authContainer.innerHTML = `
      <div class="flex items-center">
        <div class="mr-2">
          <div class="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
          </div>
        </div>
        <span class="text-gray-300 text-sm mr-3">Mode Tamu</span>
        <button id="header-login-btn" class="auth-button login text-sm">
          Masuk
        </button>
      </div>
    `;

            document
              .getElementById("header-login-btn")
              .addEventListener("click", () => {
                showSettings();
              });
          } else {
            // Not logged in
            authContainer.innerHTML = `
      <div class="flex items-center">
        <button id="header-register-btn" class="auth-button register text-sm">
          Daftar
        </button>
        <button id="header-login-btn" class="auth-button login text-sm">
          Masuk
        </button>
      </div>
    `;

            document
              .getElementById("header-login-btn")
              .addEventListener("click", () => {
                showSettings();
              });

            document
              .getElementById("header-register-btn")
              .addEventListener("click", () => {
                showSettings();
              });
          }
        }
        // Initialize app
        initializeApp();

        function initializeApp() {
          try {
            setupMainMenu();
            setupEventListeners();

            // Initialize theme and auth
            initializeTheme();
            initializeAuth();

            // Update header auth display
            updateHeaderAuth();

            console.log("App initialized successfully");
          } catch (error) {
            showError(error);
          }
        }

        // Setup main menu - FIXED
        function setupMainMenu() {
          const btnNewBRD = document.getElementById("btn-new-brd");
          const btnEditBRD = document.getElementById("btn-edit-brd");
          const btnPreviewBRD = document.getElementById("btn-preview-brd");
          const btnBackToMenu = document.getElementById("btn-back-to-menu");
          const btnBackToList = document.getElementById("btn-back-to-list");
          const btnHomeFromWizard = document.getElementById(
            "btn-home-from-wizard"
          );
          const btnDownloadPDF = document.getElementById("btn-download-pdf");
          const btnSettings = document.getElementById("btn-settings");

          // Replace the btnNewBRD event listener at around line 693
          if (btnNewBRD) {
            console.log("Adding click listener to New BRD button");
            btnNewBRD.addEventListener("click", () => {
              console.log("New BRD button clicked");
              try {
                // Check if user is logged in or in guest mode
                const isLoggedIn = !!currentUser;
                const isGuestMode =
                  localStorage.getItem("userMode") === "guest";
                console.log("Auth state:", { isLoggedIn, isGuestMode });

                if (isLoggedIn || isGuestMode) {
                  console.log("Creating new BRD");
                  currentBRDId = null;
                  clearDraft();
                  showWizard();
                } else {
                  console.log("Showing auth modal");
                  showAuthModal();
                }
              } catch (error) {
                console.error("Error handling New BRD click:", error);
              }
            });
          }

          if (btnEditBRD) {
            btnEditBRD.addEventListener("click", () => {
              showBRDList("edit");
            });
          }

          if (btnPreviewBRD) {
            btnPreviewBRD.addEventListener("click", () => {
              showBRDList("preview");
            });
          }

          if (btnBackToMenu) {
            btnBackToMenu.addEventListener("click", showMainMenu);
          }

          if (btnBackToList) {
            btnBackToList.addEventListener("click", () => {
              showBRDList("preview");
            });
          }

          if (btnHomeFromWizard) {
            btnHomeFromWizard.addEventListener("click", showMainMenu);
          }

          if (btnDownloadPDF) {
            btnDownloadPDF.addEventListener("click", downloadPDF);
          }

          if (btnSettings) {
            btnSettings.classList.remove("opacity-50"); // Remove disabled appearance
            btnSettings.querySelector("h2").classList.remove("text-gray-500");
            btnSettings.querySelector("h2").classList.add("text-blue-400");
            btnSettings.querySelector("p").classList.remove("text-gray-500");
            btnSettings.querySelector("p").classList.add("text-gray-400");
            btnSettings.querySelector("p").textContent =
              "Tema dan akun pengguna";

            btnSettings.addEventListener("click", showSettings);
          }

          // Add back button for settings
          const btnBackFromSettings = document.getElementById(
            "btn-back-from-settings"
          );
          if (btnBackFromSettings) {
            btnBackFromSettings.addEventListener("click", showMainMenu);
          }
        }

        // Clear draft function - NEW
        function clearDraft() {
          try {
            localStorage.removeItem("brd_draft");
            console.log("Draft cleared");
          } catch (error) {
            showError(error);
          }
        }

        // Setup event listeners
        function setupEventListeners() {
          const prevBtn = document.getElementById("prevBtn");
          const nextBtn = document.getElementById("nextBtn");

          if (prevBtn) {
            prevBtn.addEventListener("click", () => {
              if (currentStep > 0) {
                currentStep--;
                showStep(currentStep);
              }
            });
          }

          if (nextBtn) {
            nextBtn.addEventListener("click", () => {
              if (validateStep(currentStep)) {
                if (currentStep < sections.length - 1) {
                  currentStep++;
                  showStep(currentStep);
                } else {
                  finishBRD();
                }
              }
            });
          }
        }

        // Error handling
        function showError(error) {
          console.error("BRD Generator Error:", error);
          showToast(`Terjadi kesalahan: ${error.message}`, "error");
        }

        // Data collection - FIXED
        function collectAllData() {
          try {
            if (!formContainer) return {};

            const data = {};

            // Collect regular input fields
            const regularInputs = formContainer.querySelectorAll(
              'textarea, input[id^="input-"], select[id^="input-"]'
            );
            regularInputs.forEach((el) => {
              if (!el.id.includes("-item-") && !el.dataset.field && el.id) {
                data[el.id] = el.value || "";
              }
            });

            // Collect single input lists
            singleInputLists.forEach((key) => {
              const container = document.getElementById(key);
              if (container) {
                const inputs = container.querySelectorAll('input[type="text"]');
                data[key] = Array.from(inputs)
                  .map((input) => input.value.trim())
                  .filter((value) => value && value !== "" && value !== "-");
              }
            });

            // Collect multi-input lists - FIXED
            multiInputLists.forEach((list) => {
              const container = document.getElementById(list.key);
              if (container) {
                const items = container.querySelectorAll(list.selector);
                data[list.key] = Array.from(items)
                  .map((item) => {
                    const itemData = {};
                    list.fields.forEach((field) => {
                      // FIX: Handle both string and object field definitions
                      const fieldName =
                        typeof field === "string" ? field : field.id || field;
                      const input = item.querySelector(
                        `[data-field="${fieldName}"]`
                      );
                      itemData[fieldName] = input ? input.value.trim() : "";
                    });
                    return itemData;
                  })
                  .filter((itemData) => {
                    return Object.values(itemData).some(
                      (v) => v && v !== "" && v !== "-"
                    );
                  });
              }
            });

            console.log("Data collected:", data);
            return data;
          } catch (error) {
            showError(error);
            return {};
          }
        }

        // Data loading - ENHANCED with better error handling
        function loadData(data) {
          try {
            if (!data || !formContainer) {
              console.warn("No data to load or form container not found");
              return;
            }

            console.log("Loading data:", data);

            // Reset form first - IMPORTANT: Clear existing data
            resetForm();

            // Wait for form to be reset and dynamic lists to be setup, then load data
            setTimeout(() => {
              try {
                // Load regular input fields
                const regularInputs = formContainer.querySelectorAll(
                  'textarea, input[id^="input-"], select[id^="input-"]'
                );
                regularInputs.forEach((el) => {
                  if (
                    data[el.id] &&
                    !el.id.includes("-item-") &&
                    !el.dataset.field
                  ) {
                    el.value = data[el.id];
                  }
                });

                // Load single input lists - FIXED: Check if data exists and is not empty
                singleInputLists.forEach((key) => {
                  const values = data[key];
                  if (values && Array.isArray(values) && values.length > 0) {
                    values.forEach((value) => {
                      if (
                        dynamicListAdders[key] &&
                        value &&
                        value.trim() !== ""
                      ) {
                        dynamicListAdders[key](value);
                      }
                    });
                  }
                });

                // Load multi-input lists - FIXED: Check if data exists and is not empty
                multiInputLists.forEach((list) => {
                  const items = data[list.key];
                  if (items && Array.isArray(items) && items.length > 0) {
                    items.forEach((itemData) => {
                      if (
                        dynamicListAdders[list.key] &&
                        itemData &&
                        typeof itemData === "object"
                      ) {
                        // Check if itemData has at least one non-empty value
                        const hasData = Object.values(itemData).some(
                          (v) => v && v.toString().trim() !== ""
                        );
                        if (hasData) {
                          dynamicListAdders[list.key](itemData);
                        }
                      }
                    });
                  }
                });

                console.log("Data loaded successfully");
              } catch (error) {
                console.error("Error loading data:", error);
                showError(error);
              }
            }, 250); // Increased timeout to ensure dynamic lists are ready
          } catch (error) {
            showError(error);
          }
        }

        // Ensure showAuthModal is available where it's needed
        window.showAuthModal = function () {
          const modal = document.getElementById("auth-modal");
          if (!modal) {
            console.error("Auth modal element not found");
            return;
          }

          console.log("Showing auth modal");
          modal.classList.remove("hidden");
          document.body.classList.add("overflow-hidden");

          // Setup event listeners...
          // Rest of your existing function
        };

        // Form reset - ENHANCED
        function resetForm() {
          try {
            if (!formContainer) return;

            console.log("Resetting form...");

            // Clear regular inputs
            formContainer
              .querySelectorAll("textarea, input, select")
              .forEach((el) => {
                if (!el.id.includes("-item-") && !el.dataset.field) {
                  el.value = "";
                  el.classList.remove("invalid-field");
                }
              });

            // Clear dynamic lists - ENHANCED: Force clear all containers
            [...singleInputLists, ...multiInputLists.map((l) => l.key)].forEach(
              (key) => {
                const container = document.getElementById(key);
                if (container) {
                  // Force clear by removing all child elements
                  while (container.firstChild) {
                    container.removeChild(container.firstChild);
                  }
                  container.innerHTML = ""; // Double ensure it's empty
                }
              }
            );

            console.log("Form reset successfully");
          } catch (error) {
            showError(error);
          }
        }

        // Navigation functions - ENHANCED
        function showMainMenu() {
          try {
            // Reset wizard state
            dynamicListsInitialized = false;
            currentBRDId = null;
            currentStep = 0;

            // Menampilkan menu utama dan menyembunyikan halaman lain
            document.getElementById("main-menu").classList.remove("hidden");
            document.getElementById("brd-list-page").classList.add("hidden");
            document.getElementById("brd-preview-page").classList.add("hidden");
            document.getElementById("wizard-container").classList.add("hidden");
            document.getElementById("settings-page").classList.add("hidden");

            // Tampilkan kembali tombol auth di header
            const headerAuthContainer = document.getElementById(
              "header-auth-container"
            );
            if (headerAuthContainer) {
              headerAuthContainer.style.display = "flex";
            }

            console.log("Returned to main menu");
          } catch (error) {
            showError(error);
          }
        }

        // Format date function
        function formatDate(dateString) {
          try {
            if (!dateString) return "-";

            const date = new Date(dateString);

            // Check if date is valid
            if (isNaN(date.getTime())) {
              return "-";
            }

            return date.toLocaleDateString("id-ID", {
              year: "numeric",
              month: "long",
              day: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            });
          } catch (error) {
            console.error("Error formatting date:", error);
            return "-";
          }
        }

        // Edit BRD function
        function editBRD(id) {
          try {
            const brdData = loadBRD(id);
            if (brdData) {
              currentBRDId = id;
              console.log("Editing BRD with ID:", id);

              showWizard();

              // Load data after wizard is fully initialized
              setTimeout(() => {
                if (brdData.data) {
                  loadData(brdData.data);
                }
              }, 400);
            } else {
              showError(new Error("BRD data not found"));
            }
          } catch (error) {
            showError(error);
          }
        }

        // Duplicate BRD function
        function duplicateBRD(id) {
          try {
            const originalBRD = loadBRD(id);
            if (!originalBRD) {
              showToast("BRD tidak ditemukan", "error");
              return;
            }

            // Create new BRD with duplicated data
            const duplicatedData = { ...originalBRD.data };

            // Modify title to indicate it's a copy
            const originalTitle =
              duplicatedData["input-nama-proyek"] || "BRD Tanpa Judul";
            duplicatedData["input-nama-proyek"] = `${originalTitle} (Salinan)`;

            // Save as new BRD
            const newBrdId = saveBRD(duplicatedData);

            if (newBrdId) {
              showToast("BRD berhasil diduplikat!", "success");
              // Refresh the list
              showBRDList("edit");
            }
          } catch (error) {
            showError(error);
          }
        }

        // Delete BRD function
        function deleteBRD(id) {
          try {
            const brdData = loadBRD(id);
            if (!brdData) {
              showToast("BRD tidak ditemukan", "error");
              return;
            }

            const title =
              brdData.data["input-nama-proyek"] || "BRD Tanpa Judul";

            if (
              confirm(
                `Apakah Anda yakin ingin menghapus "${title}"?\n\nTindakan ini tidak dapat dibatalkan.`
              )
            ) {
              // Remove from localStorage
              localStorage.removeItem(`brd_${id}`);

              // Update BRD list
              let brdList = JSON.parse(
                localStorage.getItem("brd_list") || "[]"
              );
              brdList = brdList.filter((item) => item.id !== id);
              localStorage.setItem("brd_list", JSON.stringify(brdList));

              showToast("BRD berhasil dihapus", "success");

              // Refresh the list
              showBRDList("edit");
            }
          } catch (error) {
            showError(error);
          }
        }

        // Export BRD function
        function exportBRD(id) {
          try {
            const brdData = loadBRD(id);
            if (!brdData) {
              showToast("BRD tidak ditemukan", "error");
              return;
            }

            const title = brdData.data["input-nama-proyek"] || "BRD";
            const dataStr = JSON.stringify(brdData, null, 2);
            const dataBlob = new Blob([dataStr], { type: "application/json" });

            const link = document.createElement("a");
            link.href = URL.createObjectURL(dataBlob);
            link.download = `${title.replace(/[^a-z0-9]/gi, "_")}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast("BRD berhasil diekspor!", "success");
          } catch (error) {
            showError(error);
          }
        }

        // Show wizard function
        function showWizard() {
          try {
            console.log("Showing wizard...");

            // Sembunyikan tombol masuk di header saat dalam mode wizard
            const headerAuthContainer = document.getElementById(
              "header-auth-container"
            );
            if (headerAuthContainer) {
              headerAuthContainer.style.display = "none";
            }

            // Initialize wizard elements
            formContainer = document.getElementById("brd-form");
            sidebarNav = document.getElementById("sidebar-nav");
            wizardContainer = document.getElementById("wizard-container");

            if (!formContainer || !sidebarNav || !wizardContainer) {
              showError(new Error("Wizard elements not found"));
              return;
            }

            // Generate form first
            generateForm();

            // Setup dynamic lists if not already initialized
            if (!dynamicListsInitialized) {
              setupAllDynamicLists();
              dynamicListsInitialized = true;
              console.log("Dynamic lists initialized");
            }

            // Reset step and show first step
            currentStep = 0;
            showStep(currentStep);

            // Show wizard container
            document.getElementById("main-menu").classList.add("hidden");
            document.getElementById("brd-list-page").classList.add("hidden");
            document.getElementById("brd-preview-page").classList.add("hidden");
            document
              .getElementById("wizard-container")
              .classList.remove("hidden");

            // Load draft if exists and we're creating a new BRD
            if (!currentBRDId) {
              const draft = getCurrentDraft();
              if (draft && draft.data) {
                setTimeout(() => {
                  loadData(draft.data);
                  if (draft.step !== undefined) {
                    currentStep = draft.step;
                    showStep(currentStep);
                  }
                }, 300);
              }
            }

            console.log("Wizard shown successfully");
          } catch (error) {
            showError(error);
          }
        }

        // Preview BRD function
        function previewBRD(id) {
          try {
            const brdData = loadBRD(id);
            if (brdData) {
              generatePreview(brdData.data);

              document.getElementById("main-menu").classList.add("hidden");
              document.getElementById("brd-list-page").classList.add("hidden");
              document
                .getElementById("brd-preview-page")
                .classList.remove("hidden");
              document
                .getElementById("wizard-container")
                .classList.add("hidden");
            } else {
              showError(new Error("BRD data not found"));
            }
          } catch (error) {
            showError(error);
          }
        }

        // Download PDF function - improved professional version
        function downloadPDF() {
          try {
            // Check if jsPDF is available
            if (typeof window.jspdf === "undefined") {
              showToast("Library PDF tidak tersedia", "error");
              return;
            }

            const { jsPDF } = window.jspdf;

            // Get BRD data
            const previewContent = document.getElementById("preview-content");
            const titleElement = previewContent.querySelector("h1");
            const title = titleElement
              ? titleElement.textContent
              : "Business Requirement Document";

            // Get company info for header
            const companyName =
              document.getElementById("input-nama-perusahaan")?.value ||
              previewContent
                .querySelector("p:contains('Perusahaan/Organisasi')")
                .textContent.split(":")[1]
                .trim() ||
              "Company Name";

            // Create PDF with standard business document size
            const doc = new jsPDF({
              orientation: "portrait",
              unit: "mm",
              format: "a4",
              compress: true,
            });

            // Set document properties
            doc.setProperties({
              title: title,
              subject: "Business Requirement Document",
              author: companyName,
              creator: "BRD Generator",
            });

            // Set fonts
            doc.setFont("helvetica", "normal");

            // Document constants
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 20; // margin in mm
            const textWidth = pageWidth - 2 * margin;
            const lineHeight = 7; // line height in mm

            // --- COVER PAGE ---
            // Background color rectangle for top header
            doc.setFillColor(42, 59, 79); // Dark blue background
            doc.rect(0, 0, pageWidth, 50, "F");

            // Company name on cover
            doc.setTextColor(255, 255, 255); // White text
            doc.setFontSize(16);
            doc.text(companyName, margin, 30);

            // Document title
            doc.setFontSize(28);
            doc.setTextColor(0, 0, 0); // Black text
            doc.setFont("helvetica", "bold");
            const titleLines = doc.splitTextToSize(title, textWidth);
            doc.text(titleLines, pageWidth / 2, 100, { align: "center" });

            // Subtitle
            doc.setFontSize(18);
            doc.setFont("helvetica", "normal");
            doc.text("Business Requirement Document", pageWidth / 2, 120, {
              align: "center",
            });

            // Date on cover
            const today = new Date().toLocaleDateString("id-ID", {
              year: "numeric",
              month: "long",
              day: "numeric",
            });
            doc.setFontSize(12);
            doc.text(`Created: ${today}`, pageWidth / 2, 140, {
              align: "center",
            });

            // Document footer
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100); // Gray text
            doc.text(
              "CONFIDENTIAL - INTERNAL USE ONLY",
              pageWidth / 2,
              pageHeight - 20,
              { align: "center" }
            );

            // --- TABLE OF CONTENTS ---
            doc.addPage();

            // Header for Table of Contents
            addPageHeader(doc, "Table of Contents", companyName);

            // Get section headings for TOC
            const sections = previewContent.querySelectorAll("h2");
            let tocY = 50;

            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.setFont("helvetica", "bold");
            doc.text("Table of Contents", margin, tocY);
            tocY += lineHeight * 2;

            doc.setFont("helvetica", "normal");
            let pageNum = 3; // Cover + TOC = 2 pages already

            sections.forEach((section, index) => {
              const secNum = section.textContent.split(".")[0].trim();
              const secTitle =
                section.textContent.split(".")[1]?.trim() ||
                section.textContent;

              doc.setFontSize(11);
              doc.text(`${secNum}. ${secTitle}`, margin, tocY);

              // Add page number and dots
              doc.text(`${pageNum}`, pageWidth - margin, tocY, {
                align: "right",
              });

              // Draw dotted line
              const textWidth =
                (doc.getStringUnitWidth(`${secNum}. ${secTitle}`) * 11) /
                doc.internal.scaleFactor;
              const dotsStart = margin + textWidth + 5;
              const dotsEnd = pageWidth - margin - 10;

              doc.setLineDash([0.5, 1]);
              doc.setDrawColor(150, 150, 150);
              doc.line(dotsStart, tocY - 1, dotsEnd, tocY - 1);
              doc.setLineDash([]);

              tocY += lineHeight;
              pageNum++;
            });

            // --- CONTENT PAGES ---
            // Process each section
            sections.forEach((section, index) => {
              doc.addPage();

              // Get section title and content
              const sectionTitle = section.textContent;
              addPageHeader(doc, sectionTitle, companyName);

              let yPos = 50;
              doc.setFontSize(16);
              doc.setFont("helvetica", "bold");
              doc.setTextColor(42, 59, 79); // Dark blue for headings
              doc.text(sectionTitle, margin, yPos);
              yPos += lineHeight * 1.5;

              // Process content between this section and next section
              const nextSection = sections[index + 1];
              let currentElement = section.nextElementSibling;

              while (currentElement && currentElement !== nextSection) {
                // Reset text settings for regular content
                doc.setFont("helvetica", "normal");
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);

                // Handle different element types
                if (currentElement.tagName === "H3") {
                  // Sub-heading
                  yPos += lineHeight / 2;
                  doc.setFontSize(14);
                  doc.setFont("helvetica", "bold");
                  doc.setTextColor(70, 70, 70);
                  const subheadingText = currentElement.textContent;
                  const subheadingLines = doc.splitTextToSize(
                    subheadingText,
                    textWidth
                  );

                  // Check if enough space left
                  if (
                    yPos + subheadingLines.length * lineHeight >
                    pageHeight - margin
                  ) {
                    doc.addPage();
                    addPageHeader(doc, sectionTitle, companyName);
                    yPos = 50;
                  }

                  doc.text(subheadingLines, margin, yPos);
                  yPos += subheadingLines.length * lineHeight;
                } else if (currentElement.tagName === "P") {
                  // Paragraph
                  const paragraphText = currentElement.textContent;
                  const paragraphLines = doc.splitTextToSize(
                    paragraphText,
                    textWidth
                  );

                  // Check if enough space left
                  if (
                    yPos + paragraphLines.length * lineHeight >
                    pageHeight - margin
                  ) {
                    doc.addPage();
                    addPageHeader(doc, sectionTitle, companyName);
                    yPos = 50;
                  }

                  doc.text(paragraphLines, margin, yPos);
                  yPos += paragraphLines.length * lineHeight;
                } else if (currentElement.tagName === "UL") {
                  // Unordered list
                  const items = currentElement.querySelectorAll("li");

                  items.forEach((item) => {
                    const bulletText = "• " + item.textContent;
                    const bulletLines = doc.splitTextToSize(
                      bulletText,
                      textWidth - 5
                    );

                    // Check if enough space left
                    if (
                      yPos + bulletLines.length * lineHeight >
                      pageHeight - margin
                    ) {
                      doc.addPage();
                      addPageHeader(doc, sectionTitle, companyName);
                      yPos = 50;
                    }

                    doc.text(bulletLines, margin + 5, yPos);
                    yPos += bulletLines.length * lineHeight;
                  });
                } else if (currentElement.tagName === "TABLE") {
                  // Table element
                  yPos += lineHeight / 2;

                  // Get table headers and rows
                  const headers = Array.from(
                    currentElement.querySelectorAll("th")
                  ).map((th) => th.textContent);
                  const rows = Array.from(
                    currentElement.querySelectorAll("tbody tr")
                  ).map((tr) =>
                    Array.from(tr.querySelectorAll("td")).map(
                      (td) => td.textContent
                    )
                  );

                  // Check if enough space left for table header
                  if (yPos + lineHeight * 2 > pageHeight - margin) {
                    doc.addPage();
                    addPageHeader(doc, sectionTitle, companyName);
                    yPos = 50;
                  }

                  // Configure table settings
                  const tableConfig = {
                    headStyles: {
                      fillColor: [60, 91, 112],
                      textColor: 255,
                      fontStyle: "bold",
                    },
                    bodyStyles: {
                      textColor: 0,
                    },
                    alternateRowStyles: {
                      fillColor: [240, 240, 240],
                    },
                    margin: { top: yPos },
                    startY: yPos,
                  };

                  // Draw the table
                  doc.autoTable({
                    head: [headers],
                    body: rows,
                    theme: "grid",
                    styles: { overflow: "linebreak" },
                    columnStyles: {
                      0: { cellWidth: "auto" },
                      1: { cellWidth: "auto" },
                      2: { cellWidth: "auto" },
                    },
                    ...tableConfig,
                  });

                  // Update position after table
                  yPos = doc.previousAutoTable.finalY + lineHeight;
                }

                // Add spacing between elements
                yPos += lineHeight;

                // Move to next element
                currentElement = currentElement.nextElementSibling;
              }
            });

            // Add page numbers to all pages except cover
            const totalPages = doc.internal.getNumberOfPages();

            for (let i = 2; i <= totalPages; i++) {
              doc.setPage(i);
              doc.setFontSize(9);
              doc.setTextColor(100, 100, 100);
              doc.text(
                `Page ${i - 1} of ${totalPages - 1}`,
                pageWidth - margin,
                pageHeight - 10,
                { align: "right" }
              );
            }

            // Function to add consistent header to pages
            function addPageHeader(doc, sectionTitle, companyName) {
              // Header line
              doc.setDrawColor(60, 91, 112);
              doc.setLineWidth(0.5);
              doc.line(margin, 20, pageWidth - margin, 20);

              // Company name in header
              doc.setFontSize(9);
              doc.setTextColor(60, 91, 112);
              doc.text(companyName, margin, 15);

              // Document title in header
              doc.setFontSize(9);
              doc.setTextColor(60, 91, 112);
              doc.text(title, pageWidth - margin, 15, { align: "right" });
            }

            // Save the PDF
            const fileName = `${title.replace(/[^a-z0-9]/gi, "_")}.pdf`;
            doc.save(fileName);

            showToast("PDF berhasil diunduh!", "success");
          } catch (error) {
            console.error("Error generating PDF:", error);
            showToast("Error saat membuat PDF: " + error.message, "error");
          }
        }

        // Tambahkan fungsi generatePreview yang lengkap dan benar

        function generatePreview(data) {
          try {
            const previewContent = document.getElementById("preview-content");
            if (!previewContent) return;

            const title =
              data["input-nama-proyek"] || "Business Requirement Document";

            let html = `
                <h1 class="text-3xl font-bold text-white mb-8">${title}</h1>

                <h2 class="text-2xl font-semibold text-blue-400 mb-4">1. Informasi Umum</h2>
                <div class="mb-6">
                  <p><strong>Perusahaan/Organisasi:</strong> ${
                    data["input-nama-perusahaan"] || "-"
                  }</p>
                  <p><strong>Departemen/Unit:</strong> ${
                    data["input-departemen"] || "-"
                  }</p>
                  <p><strong>Sponsor Proyek:</strong> ${
                    data["input-sponsor-proyek"] || "-"
                  }</p>
                  <p><strong>Manajer Proyek:</strong> ${
                    data["input-manajer-proyek"] || "-"
                  }</p>
                  <p><strong>Tanggal Pembuatan:</strong> ${
                    data["input-tanggal-pembuatan"] || "-"
                  }</p>
                </div>

                ${
                  data["input-ringkasan-eksekutif"]
                    ? `
                  <h3 class="text-xl font-semibold text-blue-300 mb-2">Ringkasan Eksekutif</h3>
                  <p class="mb-4">${data["input-ringkasan-eksekutif"]}</p>
                `
                    : ""
                }

                ${
                  data["input-latar-belakang"]
                    ? `
                  <h3 class="text-xl font-semibold text-blue-300 mb-2">Latar Belakang</h3>
                  <p class="mb-6">${data["input-latar-belakang"]}</p>
                `
                    : ""
                }
              `;

            // Add tujuan bisnis section
            if (
              data["tujuan-bisnis-list"] &&
              data["tujuan-bisnis-list"].length > 0
            ) {
              html += `
                  <h2 class="text-2xl font-semibold text-blue-400 mb-4">2. Tujuan Bisnis</h2>
                  <ul class="mb-6 list-disc pl-5">
                    ${data["tujuan-bisnis-list"]
                      .map((item) => `<li>${item}</li>`)
                      .join("")}
                  </ul>
                `;
            }

            // Add ruang lingkup section
            html += `<h2 class="text-2xl font-semibold text-blue-400 mb-4">3. Ruang Lingkup</h2>`;

            if (data["in-scope-list"] && data["in-scope-list"].length > 0) {
              html += `
                  <h3 class="text-xl font-semibold text-blue-300 mb-2">Yang Termasuk (In Scope)</h3>
                  <ul class="mb-4 list-disc pl-5">
                    ${data["in-scope-list"]
                      .map((item) => `<li>${item}</li>`)
                      .join("")}
                  </ul>
                `;
            }

            if (
              data["out-of-scope-list"] &&
              data["out-of-scope-list"].length > 0
            ) {
              html += `
                  <h3 class="text-xl font-semibold text-blue-300 mb-2">Yang Tidak Termasuk (Out of Scope)</h3>
                  <ul class="mb-6 list-disc pl-5">
                    ${data["out-of-scope-list"]
                      .map((item) => `<li>${item}</li>`)
                      .join("")}
                  </ul>
                `;
            }

            // Add stakeholders section
            if (
              data["stakeholders-list"] &&
              data["stakeholders-list"].length > 0
            ) {
              html += `
                  <h2 class="text-2xl font-semibold text-blue-400 mb-4">4. Stakeholders</h2>
                  <table class="w-full mb-6">
                    <thead>
                      <tr>
                        <th>Nama</th>
                        <th>Peran</th>
                        <th>Tanggung Jawab</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${data["stakeholders-list"]
                        .map(
                          (stakeholder) => `
                        <tr>
                          <td>${stakeholder.name || "-"}</td>
                          <td>${stakeholder.role || "-"}</td>
                          <td>${stakeholder.responsibility || "-"}</td>
                        </tr>
                      `
                        )
                        .join("")}
                    </tbody>
                  </table>
                `;
            }

            // Add kebutuhan bisnis section
            html += `<h2 class="text-2xl font-semibold text-blue-400 mb-4">5. Kebutuhan Bisnis</h2>`;

            if (data["fungsional-list"] && data["fungsional-list"].length > 0) {
              html += `
                  <h3 class="text-xl font-semibold text-blue-300 mb-2">Kebutuhan Fungsional</h3>
                  <ul class="mb-4 list-disc pl-5">
                    ${data["fungsional-list"]
                      .map((item) => `<li>${item}</li>`)
                      .join("")}
                  </ul>
                `;
            }

            if (
              data["non-fungsional-list"] &&
              data["non-fungsional-list"].length > 0
            ) {
              html += `
                  <h3 class="text-xl font-semibold text-blue-300 mb-2">Kebutuhan Non-Fungsional</h3>
                  <ul class="mb-6 list-disc pl-5">
                    ${data["non-fungsional-list"]
                      .map((item) => `<li>${item}</li>`)
                      .join("")}
                  </ul>
                `;
            }

            // Add kriteria keberhasilan section
            if (
              data["kriteria-keberhasilan-list"] &&
              data["kriteria-keberhasilan-list"].length > 0
            ) {
              html += `
                  <h2 class="text-2xl font-semibold text-blue-400 mb-4">6. Kriteria Keberhasilan</h2>
                  <table class="w-full mb-6">
                    <thead>
                      <tr>
                        <th>Kriteria</th>
                        <th>Metrik</th>
                        <th>Target</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${data["kriteria-keberhasilan-list"]
                        .map(
                          (kriteria) => `
                        <tr>
                          <td>${kriteria.kriteria || "-"}</td>
                          <td>${kriteria.metrik || "-"}</td>
                          <td>${kriteria.target || "-"}</td>
                        </tr>
                      `
                        )
                        .join("")}
                    </tbody>
                  </table>
                `;
            }

            // Add timeline section
            if (data["timeline-list"] && data["timeline-list"].length > 0) {
              html += `
                  <h2 class="text-2xl font-semibold text-blue-400 mb-4">7. Timeline</h2>
                  <table class="w-full mb-6">
                    <thead>
                      <tr>
                        <th>Fase</th>
                        <th>Durasi</th>
                        <th>Tanggal Mulai</th>
                        <th>Tanggal Selesai</th>
                        <th>Aktivitas</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${data["timeline-list"]
                        .map(
                          (timeline) => `
                        <tr>
                          <td>${timeline.fase || "-"}</td>
                          <td>${timeline.durasi || "-"}</td>
                          <td>${timeline.tanggalMulai || "-"}</td>
                          <td>${timeline.tanggalSelesai || "-"}</td>
                          <td>${timeline.aktivitas || "-"}</td>
                        </tr>
                      `
                        )
                        .join("")}
                    </tbody>
                  </table>
                `;
            }

            // Add biaya & sumber daya section

            html += `<h2 class="text-2xl font-semibold text-blue-400 mb-4">8. Biaya & Sumber Daya</h2>`;

            if (data["biaya-list"] && data["biaya-list"].length > 0) {
              html += `
                  <h3 class="text-xl font-semibold text-blue-300 mb-2">Estimasi Biaya</h3>
                  <table class="w-full mb-4">
                    <thead>
                      <tr>
                        <th>Item</th>
                        <th>Jumlah</th>
                        <th>Keterangan</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${data["biaya-list"]
                        .map(
                          (biaya) => `
                        <tr>
                          <td>${biaya.item || "-"}</td>
                          <td>${biaya.jumlah || "-"}</td>
                          <td>${biaya.keterangan || "-"}</td>
                        </tr>
                      `
                        )
                        .join("")}
                    </tbody>
                  </table>
                `;
            }

            if (
              data["sumber-daya-list"] &&
              data["sumber-daya-list"].length > 0
            ) {
              html += `
                  <h3 class="text-xl font-semibold text-blue-300 mb-2">Sumber Daya yang Diperlukan</h3>
                  <table class="w-full mb-6">
                    <thead>
                      <tr>
                        <th>Peran</th>
                        <th>Nama</th>
                        <th>Alokasi</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${data["sumber-daya-list"]
                        .map(
                          (sumberDaya) => `
                        <tr>
                          <td>${sumberDaya.peran || "-"}</td>
                          <td>${sumberDaya.nama || "-"}</td>
                          <td>${sumberDaya.alokasi || "-"}</td>
                        </tr>
                      `
                        )
                        .join("")}
                    </tbody>
                  </table>
                `;
            }

            // Add asumsi & risiko section
            html += `<h2 class="text-2xl font-semibold text-blue-400 mb-4">9. Asumsi & Risiko</h2>`;

            if (data["asumsi-list"] && data["asumsi-list"].length > 0) {
              html += `
                  <h3 class="text-xl font-semibold text-blue-300 mb-2">Asumsi</h3>
                  <ul class="mb-4 list-disc pl-5">
                    ${data["asumsi-list"]
                      .map((item) => `<li>${item}</li>`)
                      .join("")}
                  </ul>
                `;
            }

            if (data["risiko-list"] && data["risiko-list"].length > 0) {
              html += `
                  <h3 class="text-xl font-semibold text-blue-300 mb-2">Identifikasi Risiko</h3>
                  <table class="w-full mb-6">
                    <thead>
                      <tr>
                        <th>Risiko</th>
                        <th>Dampak</th>
                        <th>Probabilitas</th>
                        <th>Mitigasi</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${data["risiko-list"]
                        .map(
                          (risiko) => `
                        <tr>
                          <td>${risiko.risiko || "-"}</td>
                          <td>${risiko.dampak || "-"}</td>
                          <td>${risiko.probabilitas || "-"}</td>
                          <td>${risiko.mitigasi || "-"}</td>
                        </tr>
                      `
                        )
                        .join("")}
                    </tbody>
                  </table>
                `;
            }

            // Add lampiran section
            if (data["lampiran-list"] && data["lampiran-list"].length > 0) {
              html += `
                  <h2 class="text-2xl font-semibold text-blue-400 mb-4">10. Lampiran</h2>
                  <table class="w-full mb-6">
                    <thead>
                      <tr>
                        <th>Nama</th>
                        <th>Tipe</th>
                        <th>Deskripsi</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${data["lampiran-list"]
                        .map(
                          (lampiran) => `
                        <tr>
                          <td>${lampiran.nama || "-"}</td>
                          <td>${lampiran.tipe || "-"}</td>
                          <td>${lampiran.deskripsi || "-"}</td>
                        </tr>
                      `
                        )
                        .join("")}
                    </tbody>
                  </table>
                `;
            }

            previewContent.innerHTML = html;
          } catch (error) {
            showError(error);
          }
        }

        // Helper function to show toast messages
        function showToast(message, type = "success", duration = 4000) {
          const toast = document.createElement("div");
          toast.className = `toast toast-${type}`;
          toast.textContent = message;
          document.body.appendChild(toast);

          // Remove toast after animation completes
          setTimeout(() => {
            if (toast.parentElement) {
              document.body.removeChild(toast);
            }
          }, duration);
        }

        // Auto-save on page unload
        window.addEventListener("beforeunload", (e) => {
          try {
            if (formContainer && currentBRDId === null) {
              const data = collectAllData();
              if (data && Object.keys(data).length > 0) {
                saveCurrentDraft(data);
              }
            }
          } catch (error) {
            console.error("Error saving on page unload:", error);
          }
        });

        // BRD List function - letakkan setelah semua fungsi di atas
        function showBRDList(mode) {
          const brdList = JSON.parse(localStorage.getItem("brd_list") || "[]");
          const listContainer = document.getElementById("brd-list-container");
          const listTitle = document.getElementById("brd-list-title");

          listTitle.textContent = mode === "edit" ? "Edit BRD" : "Preview BRD";

          // Hapus tombol import, hanya tampilkan header sederhana
          const headerHTML =
            mode === "edit"
              ? `
              <div class="mb-4">
                <p class="text-gray-400 text-sm">Pilih BRD yang ingin diedit atau kelola</p>
              </div>
            `
              : `
              <div class="mb-4">
                <p class="text-gray-400 text-sm">Pilih BRD yang ingin dilihat atau diunduh</p>
              </div>
            `;

          if (brdList.length === 0) {
            listContainer.innerHTML =
              headerHTML +
              `
                <div class="text-center py-8">
                  <p class="text-gray-400 mb-4">Belum ada BRD yang dibuat.</p>
                  <button id="create-first-brd" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Buat BRD Pertama
                  </button>
                </div>
              `;

            // Add event listener AFTER creating the element
            const createFirstBrdButton =
              document.getElementById("create-first-brd");
            if (createFirstBrdButton) {
              createFirstBrdButton.onclick = () => {
                currentBRDId = null;
                showWizard();
              };
            }
          } else {
            // Fix the HTML structure in the BRD list rendering function around line 2030-2035
            listContainer.innerHTML =
              headerHTML +
              brdList
                .map(
                  (brd) => `
        <div class="brd-list-item p-4 border-b border-gray-700 cursor-pointer relative group" data-id="${
          brd.id
        }">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <h3 class="text-lg font-semibold text-white mb-1">${
                brd.title
              }</h3>
              <p class="text-gray-400 text-sm">
                Dibuat: ${formatDate(brd.createdAt)}
                ${
                  brd.updatedAt && brd.updatedAt !== brd.createdAt
                    ? ` | Diperbarui: ${formatDate(brd.updatedAt)}`
                    : ""
                }
              </p>
            </div>
            ${
              mode === "edit"
                ? `
                <div class="flex space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                  <button onclick="event.stopPropagation(); editBRD('${brd.id}')"
                          class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                    Edit
                  </button>
                  <button onclick="event.stopPropagation(); duplicateBRD('${brd.id}')"
                          class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                    Duplikat
                  </button>
                  <button onclick="event.stopPropagation(); deleteBRD('${brd.id}')"
                          class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                    Hapus
                  </button>
                </div>
              `
                : `
                <div class="flex space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                  <button onclick="event.stopPropagation(); previewBRD('${brd.id}')"
                          class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                    Preview
                  </button>
                </div>
              `
            }
          </div>
        </div>
      `
                )
                .join("");

            // Add click handlers untuk item (hanya jika mengklik tombol aksi)
            listContainer.querySelectorAll(".brd-list-item").forEach((item) => {
              item.onclick = (e) => {
                // Jangan execute jika mengklik tombol
                if (e.target.tagName === "BUTTON") return;

                const brdId = item.dataset.id;
                if (mode === "edit") {
                  editBRD(brdId);
                } else {
                  previewBRD(brdId);
                }
              };
            });
          }

          document.getElementById("main-menu").classList.add("hidden");
          document.getElementById("brd-list-page").classList.remove("hidden");
          document.getElementById("brd-preview-page").classList.add("hidden");
          document.getElementById("wizard-container").classList.add("hidden");
        }

        // Form generation function
        function generateForm() {
          try {
            if (!formContainer) {
              console.error("Form container not found");
              return;
            }

            // Clear existing form
            formContainer.innerHTML = "";

            // Generate sidebar navigation
            generateSidebar();

            // Generate form sections
            sections.forEach((section, index) => {
              const sectionDiv = document.createElement("div");
              sectionDiv.id = `section-${section.id}`;
              sectionDiv.className = `form-section ${
                index === 0 ? "" : "hidden"
              }`;
              sectionDiv.innerHTML = generateSectionHTML(section);
              formContainer.appendChild(sectionDiv);
            });

            console.log("Form generated successfully");
          } catch (error) {
            showError(error);
          }
        }

        // Generate sidebar navigation
        function generateSidebar() {
          if (!sidebarNav) return;

          sidebarNav.innerHTML = sections
            .map(
              (section, index) => `
        <div class="sidebar-link p-3 rounded-md text-sm ${
          index === 0 ? "active" : ""
        }"
             data-step="${index}" onclick="goToStep(${index})">
          <span class="font-medium">${index + 1}. ${section.title}</span>
        </div>
      `
            )
            .join("");
        }

        // Generate section HTML
        function generateSectionHTML(section) {
          switch (section.id) {
            case "info-umum":
              return `
            <h2 class="text-2xl font-bold mb-6">${section.title}</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium mb-2">Nama Perusahaan/Organisasi *</label>
                <input type="text" id="input-nama-perusahaan" class="w-full p-3 border border-gray-600 rounded-md bg-gray-700 text-white" required>
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Departemen/Unit *</label>
                <input type="text" id="input-departemen" class="w-full p-3 border border-gray-600 rounded-md bg-gray-700 text-white" required>
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Nama Proyek *</label>
                <input type="text" id="input-nama-proyek" class="w-full p-3 border border-gray-600 rounded-md bg-gray-700 text-white" required>
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Sponsor Proyek</label>
                <input type="text" id="input-sponsor-proyek" class="w-full p-3 border border-gray-600 rounded-md bg-gray-700 text-white">
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Manajer Proyek</label>
                <input type="text" id="input-manajer-proyek" class="w-full p-3 border border-gray-600 rounded-md bg-gray-700 text-white">
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Tanggal Pembuatan</label>
                <input type="date" id="input-tanggal-pembuatan" class="w-full p-3 border border-gray-600 rounded-md bg-gray-700 text-white" value="${
                  new Date().toISOString().split("T")[0]
                }">
              </div>
            </div>
            <div class="mt-6">
              <label class="block text-sm font-medium mb-2">Ringkasan Eksekutif</label>
              <textarea id="input-ringkasan-eksekutif" rows="4" class="w-full p-3 border border-gray-600 rounded-md bg-gray-700 text-white" placeholder="${
                placeholders["ringkasan-eksekutif"]
              }"></textarea>
            </div>
            <div class="mt-6">
              <label class="block text-sm font-medium mb-2">Latar Belakang</label>
              <textarea id="input-latar-belakang" rows="4" class="w-full p-3 border border-gray-600 rounded-md bg-gray-700 text-white" placeholder="${
                placeholders["latar-belakang"]
              }"></textarea>
            </div>
          `;

            case "tujuan-bisnis":
              return `
            <h2 class="text-2xl font-bold mb-6">${section.title}</h2>
            <div class="mb-6">
              <label class="block text-sm font-medium mb-2">Daftar Tujuan Bisnis</label>
              <div id="tujuan-bisnis-list" class="space-y-2"></div>
              <button type="button" onclick="addToList('tujuan-bisnis-list', '')" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">+ Tambah Tujuan</button>
            </div>
          `;

            case "ruang-lingkup":
              return `
            <h2 class="text-2xl font-bold mb-6">${section.title}</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium mb-2">Yang Termasuk (In Scope)</label>
                <div id="in-scope-list" class="space-y-2"></div>
                <button type="button" onclick="addToList('in-scope-list', '')" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">+ Tambah Item</button>
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Yang Tidak Termasuk (Out of Scope)</label>
                <div id="out-of-scope-list" class="space-y-2"></div>
                <button type="button" onclick="addToList('out-of-scope-list', '')" class="mt-3 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm">+ Tambah Item</button>
              </div>
            </div>
          `;

            case "stakeholders":
              return `
        <h2 class="text-2xl font-bold mb-6">${section.title}</h2>
        <div class="mb-6">
          <label class="block text-sm font-medium mb-2">Daftar Stakeholders</label>
          <div id="stakeholders-list" class="space-y-4"></div>
          <button type="button" onclick="addStakeholder()" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">+ Tambah Stakeholder</button>
        </div>
      `;

            case "kebutuhan-bisnis":
              return `
        <h2 class="text-2xl font-bold mb-6">${section.title}</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium mb-2">Kebutuhan Fungsional</label>
            <div id="fungsional-list" class="space-y-2"></div>
            <button type="button" onclick="addToList('fungsional-list', '')" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">+ Tambah Kebutuhan</button>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Kebutuhan Non-Fungsional</label>
            <div id="non-fungsional-list" class="space-y-2"></div>
            <button type="button" onclick="addToList('non-fungsional-list', '')" class="mt-3 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">+ Tambah Kebutuhan</button>
          </div>
        </div>
      `;

            case "kriteria-keberhasilan":
              return `
        <h2 class="text-2xl font-bold mb-6">${section.title}</h2>
        <div class="mb-6">
          <div id="kriteria-keberhasilan-list" class="space-y-4"></div>
          <button type="button" onclick="addKriteria()" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">+ Tambah Kriteria</button>
        </div>
      `;

            case "timeline":
              return `
        <h2 class="text-2xl font-bold mb-6">${section.title}</h2>
        <div class="mb-6">
          <div id="timeline-list" class="space-y-4"></div>
          <button type="button" onclick="addTimeline()" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">+ Tambah Timeline</button>
        </div>
      `;

            case "biaya-sumber-daya":
              return `
        <h2 class="text-2xl font-bold mb-6">${section.title}</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium mb-2">Estimasi Biaya</label>
            <div id="biaya-list" class="space-y-4"></div>
            <button type="button" onclick="addBiaya()" class="mt-3 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">+ Tambah Item Biaya</button>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Sumber Daya yang Diperlukan</label>
            <div id="sumber-daya-list" class="space-y-4"></div>
            <button type="button" onclick="addSumberDaya()" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">+ Tambah Sumber Daya</button>
          </div>
        </div>
      `;

            case "asumsi-risiko":
              return `
        <h2 class="text-2xl font-bold mb-6">${section.title}</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium mb-2">Asumsi</label>
            <div id="asumsi-list" class="space-y-2"></div>
            <button type="button" onclick="addToList('asumsi-list', '')" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">+ Tambah Asumsi</button>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Identifikasi Risiko</label>
            <div id="risiko-list" class="space-y-4"></div>
            <button type="button" onclick="addRisiko()" class="mt-3 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm">+ Tambah Risiko</button>
          </div>
        </div>
      `;

            case "lampiran":
              return `
        <h2 class="text-2xl font-bold mb-6">${section.title}</h2>
        <div class="mb-6">
          <div id="lampiran-list" class="space-y-4"></div>
          <button type="button" onclick="addLampiran()" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">+ Tambah Lampiran</button>
        </div>
      `;
          }
        }

        // Show step function
        function showStep(step) {
          try {
            if (step < 0 || step >= sections.length) return;

            // Hide all sections
            document.querySelectorAll(".form-section").forEach((section) => {
              section.classList.add("hidden");
            });

            // Show current section
            const currentSection = document.getElementById(
              `section-${sections[step].id}`
            );
            if (currentSection) {
              currentSection.classList.remove("hidden");
            }

            // Update sidebar
            updateSidebar(step);

            // Update navigation buttons
            updateNavigationButtons(step);

            // Save current step for drafts
            if (!currentBRDId) {
              const data = collectAllData();
              saveCurrentDraft(data, step);
            }

            currentStep = step;
          } catch (error) {
            showError(error);
          }
        }

        // Update sidebar active state
        function updateSidebar(activeStep) {
          document.querySelectorAll(".sidebar-link").forEach((link, index) => {
            if (index === activeStep) {
              link.classList.add("active");
            } else {
              link.classList.remove("active");
            }
          });
        }

        // Update navigation buttons
        function updateNavigationButtons(step) {
          const prevBtn = document.getElementById("prevBtn");
          const nextBtn = document.getElementById("nextBtn");

          if (prevBtn) {
            prevBtn.disabled = step === 0;
            prevBtn.style.opacity = step === 0 ? "0.5" : "1";
          }

          if (nextBtn) {
            nextBtn.textContent =
              step === sections.length - 1 ? "Selesai" : "Selanjutnya";
          }
        }

        // Go to specific step
        function goToStep(step) {
          if (validateStep(currentStep)) {
            showStep(step);
          }
        }

        // Validate current step
        function validateStep(step) {
          try {
            const currentSection = document.getElementById(
              `section-${sections[step].id}`
            );
            if (!currentSection) return true;

            const requiredFields =
              currentSection.querySelectorAll("[required]");
            let isValid = true;

            requiredFields.forEach((field) => {
              field.classList.remove("invalid-field");
              if (!field.value.trim()) {
                field.classList.add("invalid-field");
                isValid = false;
              }
            });

            if (!isValid) {
              showToast("Mohon lengkapi semua field yang wajib diisi", "error");
            }

            return isValid;
          } catch (error) {
            showError(error);
            return false;
          }
        }

        // Setup all dynamic lists
        function setupAllDynamicLists() {
          try {
            // Setup single input lists
            singleInputLists.forEach((listId) => {
              setupDynamicList(listId);
            });

            // Setup multi-input lists
            multiInputLists.forEach((list) => {
              setupMultiInputList(list);
            });
          } catch (error) {
            showError(error);
          }
        }

        // Setup dynamic list for single inputs
        function setupDynamicList(listId) {
          try {
            dynamicListAdders[listId] = (value = "") => {
              const container = document.getElementById(listId);
              if (!container) return;

              const itemDiv = document.createElement("div");
              itemDiv.className = "flex items-center space-x-2";
              itemDiv.innerHTML = `
            <input type="text" value="${value}" class="flex-1 p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
            <button type="button" onclick="this.parentElement.remove()" class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-sm">×</button>
          `;
              container.appendChild(itemDiv);

              // Auto-save on input
              const input = itemDiv.querySelector("input");
              input.addEventListener("input", () => {
                if (!currentBRDId) {
                  const data = collectAllData();
                  saveCurrentDraft(data);
                }
              });
            };

            console.log(`Dynamic list setup completed: ${listId}`);
          } catch (error) {
            showError(error);
          }
        }

        // Setup multi-input list
        function setupMultiInputList(listConfig) {
          try {
            const { key, fields } = listConfig;

            dynamicListAdders[key] = (data = {}) => {
              const container = document.getElementById(key);
              if (!container) return;

              const itemDiv = document.createElement("div");
              itemDiv.className = `${key.replace(
                "-list",
                "-item"
              )} p-4 border border-gray-600 rounded bg-gray-750 mb-4`;

              let fieldsHTML = "";

              // Generate appropriate HTML based on list type
              if (key === "stakeholders-list") {
                fieldsHTML = `
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-xs font-medium mb-1">Nama</label>
                  <input type="text" data-field="name" value="${
                    data.name || ""
                  }" class="w-full p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
                </div>
                <div>
                  <label class="block text-xs font-medium mb-1">Peran</label>
                  <input type="text" data-field="role" value="${
                    data.role || ""
                  }" class="w-full p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
                </div>
                <div>
                  <label class="block text-xs font-medium mb-1">Tanggung Jawab</label>
                  <input type="text" data-field="responsibility" value="${
                    data.responsibility || ""
                  }" class="w-full p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
                </div>
              </div>
            `;
              } else if (key === "kriteria-keberhasilan-list") {
                fieldsHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-xs font-medium mb-1">Kriteria</label>
            <input type="text" data-field="kriteria" value="${
              data.kriteria || ""
            }" class="w-full p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
          </div>
          <div>
            <label class="block text-xs font-medium mb-1">Metrik</label>
            <input type="text" data-field="metrik" value="${
              data.metrik || ""
            }" class="w-full p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
          </div>
          <div>
            <label class="block text-xs font-medium mb-1">Target</label>
            <input type="text" data-field="target" value="${
              data.target || ""
            }" class="w-full p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
          </div>
        </div>
      `;
              } else if (key === "timeline-list") {
                fieldsHTML = `
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                <div>
                  <label class="block text-xs font-medium mb-1">Fase</label>
                  <input type="text" data-field="fase" value="${
                    data.fase || ""
                  }" class="w-full p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
                </div>
                <div>
                  <label class="block text-xs font-medium mb-1">Durasi</label>
                  <input type="text" data-field="durasi" value="${
                    data.durasi || ""
                  }" class="w-full p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
                </div>
                <div>
                  <label class="block text-xs font-medium mb-1">Tanggal Mulai</label>
                  <input type="date" data-field="tanggalMulai" value="${
                    data.tanggalMulai || ""
                  }" class="w-full p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
                </div>
                <div>
                  <label class="block text-xs font-medium mb-1">Tanggal Selesai</label>
                  <input type="date" data-field="tanggalSelesai" value="${
                    data.tanggalSelesai || ""
                  }" class="w-full p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
                </div>
                <div>
                  <label class="block text-xs font-medium mb-1">Aktivitas</label>
                  <input type="text" data-field="aktivitas" value="${
                    data.aktivitas || ""
                  }" class="w-full p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
                </div>
              </div>
            `;
              } else if (key === "biaya-list") {
                fieldsHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-xs font-medium mb-1">Item Biaya</label>
            <input type="text" data-field="item" value="${
              data.item || ""
            }" class="w-full p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
          </div>
          <div>
            <label class="block text-xs font-medium mb-1">Jumlah</label>
            <input type="text" data-field="jumlah" value="${
              data.jumlah || ""
            }" class="w-full p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
          </div>
          <div>
            <label class="block text-xs font-medium mb-1">Keterangan</label>
            <input type="text" data-field="keterangan" value="${
              data.keterangan || ""
            }" class="w-full p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
          </div>
        </div>
      `;
              } else if (key === "sumber-daya-list") {
                fieldsHTML = `
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-xs font-medium mb-1">Peran</label>
                  <input type="text" data-field="peran" value="${
                    data.peran || ""
                  }" class="w-full p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
                </div>
                <div>
                  <label class="block text-xs font-medium mb-1">Nama</label>
                  <input type="text" data-field="nama" value="${
                    data.nama || ""
                  }" class="w-full p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
                </div>
                <div>
                  <label class="block text-xs font-medium mb-1">Alokasi</label>
                  <input type="text" data-field="alokasi" value="${
                    data.alokasi || ""
                  }" class="w-full p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
                </div>
              </div>
            `;
              } else if (key === "risiko-list") {
                fieldsHTML = `
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                  <label class="block text-xs font-medium mb-1">Risiko</label>
                  <input type="text" data-field="risiko" value="${
                    data.risiko || ""
                  }" class="w-full p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
                </div>
                <div>
                  <label class="block text-xs font-medium mb-1">Dampak</label>
                  <select data-field="dampak" class="w-full p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
                    <option value="">Pilih...</option>
                    <option value="Rendah" ${
                      data.dampak === "Rendah" ? "selected" : ""
                    }>Rendah</option>
                    <option value="Sedang" ${
                      data.dampak === "Sedang" ? "selected" : ""
                    }>Sedang</option>
                    <option value="Tinggi" ${
                      data.dampak === "Tinggi" ? "selected" : ""
                    }>Tinggi</option>
                  </select>
                </div>
                <div>
                  <label class="block text-xs font-medium mb-1">Probabilitas</label>
                  <select data-field="probabilitas" class="w-full p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
                    <option value="">Pilih...</option>
                    <option value="Rendah" ${
                      data.probabilitas === "Rendah" ? "selected" : ""
                    }>Rendah</option>
                    <option value="Sedang" ${
                      data.probabilitas === "Sedang" ? "selected" : ""
                    }>Sedang</option>
                    <option value="Tinggi" ${
                      data.probabilitas === "Tinggi" ? "selected" : ""
                    }>Tinggi</option>
                  </select>
                </div>
                <div>
                  <label class="block text-xs font-medium mb-1">Mitigasi</label>
                  <input type="text" data-field="mitigasi" value="${
                    data.mitigasi || ""
                  }" class="w-full p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
                </div>
              </div>
            `;
              } else if (key === "lampiran-list") {
                fieldsHTML = `
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-xs font-medium mb-1">Nama Lampiran</label>
                  <input type="text" data-field="nama" value="${
                    data.nama || ""
                  }" class="w-full p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
                </div>
                <div>
                  <label class="block text-xs font-medium mb-1">Tipe</label>
                  <select data-field="tipe" class="w-full p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
                    <option value="">Pilih...</option>
                    <option value="Dokumen" ${
                      data.tipe === "Dokumen" ? "selected" : ""
                    }>Dokumen</option>
                    <option value="Gambar" ${
                      data.tipe === "Gambar" ? "selected" : ""
                    }>Gambar</option>
                    <option value="Spreadsheet" ${
                      data.tipe === "Spreadsheet" ? "selected" : ""
                    }>Spreadsheet</option>
                    <option value="Presentasi" ${
                      data.tipe === "Presentasi" ? "selected" : ""
                    }>Presentasi</option>
                    <option value="Lainnya" ${
                      data.tipe === "Lainnya" ? "selected" : ""
                    }>Lainnya</option>
                  </select>
                </div>
                <div>
                  <label class="block text-xs font-medium mb-1">Deskripsi</label>
                  <input type="text" data-field="deskripsi" value="${
                    data.deskripsi || ""
                  }" class="w-full p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
                </div>
              </div>
            `;
              }

              itemDiv.innerHTML = `
            ${fieldsHTML}
            <div class="mt-3 text-right">
              <button type="button" onclick="this.closest('.${key.replace(
                "-list",
                "-item"
              )}').remove()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">Hapus</button>
            </div>
          `;

              container.appendChild(itemDiv);

              // Auto-save on input
              itemDiv.querySelectorAll("input, select").forEach((input) => {
                input.addEventListener("input", () => {
                  if (!currentBRDId) {
                    const data = collectAllData();
                    saveCurrentDraft(data);
                  }
                });
              });
            };

            console.log(`Multi-input list setup completed: ${key}`);
          } catch (error) {
            showError(error);
          }
        }

        // Storage functions
        function saveCurrentDraft(data, step = currentStep) {
          try {
            const draft = {
              data: data,
              step: step,
              timestamp: Date.now(),
            };
            localStorage.setItem("brd_draft", JSON.stringify(draft));
            console.log("Draft saved with key: brd_draft");
          } catch (error) {
            showError(error);
          }
        }

        function getCurrentDraft() {
          try {
            const draft = localStorage.getItem("brd_draft");
            return draft ? JSON.parse(draft) : null;
          } catch (error) {
            console.error("Error loading draft:", error);
            return null;
          }
        }

        function saveBRD(data) {
          try {
            const timestamp = Date.now();
            const randomId = Math.random().toString(36).substring(2, 15);
            const brdId = currentBRDId || `brd_${timestamp}_${randomId}`;

            const brdData = {
              id: brdId,
              data: data,
              createdAt: currentBRDId
                ? loadBRD(currentBRDId)?.createdAt || timestamp
                : timestamp,
              updatedAt: timestamp,
            };

            localStorage.setItem(`brd_${brdId}`, JSON.stringify(brdData));

            // Update BRD list
            let brdList = JSON.parse(localStorage.getItem("brd_list") || "[]");

            const title = data["input-nama-proyek"] || "BRD Tanpa Judul";
            const existingIndex = brdList.findIndex(
              (item) => item.id === brdId
            );

            const listItem = {
              id: brdId,
              title: title,
              createdAt: brdData.createdAt,
              updatedAt: brdData.updatedAt,
            };

            if (existingIndex >= 0) {
              brdList[existingIndex] = listItem;
            } else {
              brdList.unshift(listItem);
            }

            localStorage.setItem("brd_list", JSON.stringify(brdList));

            console.log(`BRD saved with ID: ${brdId}`);
            return brdId;
          } catch (error) {
            showError(error);
            return null;
          }
        }

        // Cloud storage functions
        function loadBRDFromCloud(id) {
          if (!currentUser) {
            // Fallback to local storage if not logged in
            return loadBRD(id);
          }

          return new Promise((resolve, reject) => {
            const db = firebase.firestore();
            db.collection("users")
              .doc(currentUser.uid)
              .collection("brds")
              .doc(id)
              .get()
              .then((doc) => {
                if (doc.exists) {
                  resolve(doc.data());
                } else {
                  // Try local storage as fallback
                  const localBRD = loadBRD(id);
                  if (localBRD) {
                    resolve(localBRD);
                  } else {
                    reject(
                      new Error("BRD not found in cloud or local storage")
                    );
                  }
                }
              })
              .catch((error) => {
                console.error("Error loading BRD from cloud:", error);

                // Try local storage as fallback
                const localBRD = loadBRD(id);
                if (localBRD) {
                  resolve(localBRD);
                } else {
                  reject(error);
                }
              });
          });
        }

        function saveBRDToCloud(data, brdId) {
          if (!firebaseInitialized || !currentUser) {
            // Fallback to local storage if Firebase isn't configured
            return Promise.resolve(saveBRD(data));
          }

          return new Promise((resolve, reject) => {
            const timestamp = Date.now();
            const randomId = Math.random().toString(36).substring(2, 15);
            const id = brdId || `brd_${timestamp}_${randomId}`;

            const brdData = {
              id: id,
              data: data,
              createdAt: brdId
                ? loadBRDFromCloud(brdId)?.createdAt || timestamp
                : timestamp,
              updatedAt: timestamp,
              userId: currentUser.uid,
            };

            const db = firebase.firestore();

            // Save to Firestore
            db.collection("users")
              .doc(currentUser.uid)
              .collection("brds")
              .doc(id)
              .set(brdData)
              .then(() => {
                // Also save to local storage as backup
                localStorage.setItem(`brd_${id}`, JSON.stringify(brdData));

                // Update BRD list
                updateBRDList(brdData);

                resolve(id);
              })
              .catch((error) => {
                console.error("Error saving BRD to cloud:", error);

                // Try local storage as fallback
                const localId = saveBRD(data);
                if (localId) {
                  resolve(localId);
                } else {
                  reject(error);
                }
              });
          });
        }

        function updateBRDList(brdData) {
          let brdList = JSON.parse(localStorage.getItem("brd_list") || "[]");

          const title = brdData.data["input-nama-proyek"] || "BRD Tanpa Judul";
          const existingIndex = brdList.findIndex(
            (item) => item.id === brdData.id
          );

          const listItem = {
            id: brdData.id,
            title: title,
            createdAt: brdData.createdAt,
            updatedAt: brdData.updatedAt,
            userId: brdData.userId || null,
          };

          if (existingIndex >= 0) {
            brdList[existingIndex] = listItem;
          } else {
            brdList.unshift(listItem);
          }

          localStorage.setItem("brd_list", JSON.stringify(brdList));
        }

        // Helper functions for adding specific types
        window.addToList = (listId, value = "") => {
          if (dynamicListAdders[listId]) {
            dynamicListAdders[listId](value);
          }
        };

        window.addStakeholder = (data = {}) => {
          if (dynamicListAdders["stakeholders-list"]) {
            dynamicListAdders["stakeholders-list"](data);
          }
        };

        // Perbaikan fungsi addKriteria
        window.addKriteria = (data = {}) => {
          try {
            if (dynamicListAdders["kriteria-keberhasilan-list"]) {
              // Pastikan data memiliki struktur yang benar
              const kriteriaData = {
                kriteria: data.kriteria || "",
                metrik: data.metrik || "",
                target: data.target || "",
              };

              dynamicListAdders["kriteria-keberhasilan-list"](kriteriaData);

              // Auto-save setelah menambahkan item baru
              if (!currentBRDId) {
                setTimeout(() => {
                  const allData = collectAllData();
                  saveCurrentDraft(allData);
                }, 100);
              }
            } else {
              console.error("Kriteria keberhasilan adder tidak ditemukan");
            }
          } catch (error) {
            console.error("Error saat menambahkan kriteria:", error);
            showToast("Gagal menambahkan kriteria", "error");
          }
        };

        window.addTimeline = (data = {}) => {
          if (dynamicListAdders["timeline-list"]) {
            dynamicListAdders["timeline-list"](data);
          }
        };

        window.addBiaya = (data = {}) => {
          if (dynamicListAdders["biaya-list"]) {
            dynamicListAdders["biaya-list"](data);
          }
        };

        window.addSumberDaya = (data = {}) => {
          if (dynamicListAdders["sumber-daya-list"]) {
            dynamicListAdders["sumber-daya-list"](data);
          }
        };

        window.addRisiko = (data = {}) => {
          if (dynamicListAdders["risiko-list"]) {
            dynamicListAdders["risiko-list"](data);
          }
        };
        // Expose goToStep to global scope
        window.goToStep = function (step) {
          if (validateStep(currentStep)) {
            showStep(step);
          }
        };
        window.addLampiran = (data = {}) => {
          if (dynamicListAdders["lampiran-list"]) {
            dynamicListAdders["lampiran-list"](data);
          }
        };

        function loadBRD(id) {
          try {
            const brdData = localStorage.getItem(`brd_${id}`);
            const result = brdData ? JSON.parse(brdData) : null;
            if (result) {
              console.log(`BRD loaded with ID: ${id}`);
            }
            return result;
          } catch (error) {
            showError(error);
            return null;
          }
        }

        // User authentication and theme management
        function initializeTheme() {
          // Set initial theme
          applyTheme(currentTheme);

          // Set the radio button for current theme
          document.querySelector(
            `input[name="theme"][value="${currentTheme}"]`
          ).checked = true;

          // Add event listeners for theme selection
          document
            .getElementById("btn-save-theme")
            .addEventListener("click", saveTheme);
        }

        function saveTheme() {
          const selectedTheme = document.querySelector(
            'input[name="theme"]:checked'
          ).value;
          applyTheme(selectedTheme);
          localStorage.setItem("theme", selectedTheme);
          currentTheme = selectedTheme;
          showToast("Tema berhasil diubah!", "success");
        }

        function applyTheme(theme) {
          document.body.classList.remove("theme-light", "theme-blue");

          if (theme === "light") {
            document.body.classList.add("theme-light");
          } else if (theme === "blue") {
            document.body.classList.add("theme-blue");
          }

          // Update meta theme-color for mobile browsers
          document
            .querySelector('meta[name="theme-color"]')
            .setAttribute(
              "content",
              theme === "light"
                ? "#ffffff"
                : theme === "blue"
                ? "#0c4a6e"
                : "#1f2937"
            );
        }

        // Authentication functions
        function initializeAuth() {
          if (!firebaseInitialized) {
            // If Firebase isn't configured, only show guest mode option
            document.getElementById("btn-google-login").style.display = "none";
            document.getElementById("btn-switch-to-account").style.display =
              "none";

            // Show a message in the Firebase login area
            const notConfiguredMsg = document.createElement("p");
            notConfiguredMsg.className = "text-amber-400 text-sm mb-3";
            notConfiguredMsg.textContent =
              "Google login tidak tersedia (Firebase tidak dikonfigurasi)";

            const loginContainer = document.getElementById(
              "account-not-logged-in"
            );
            loginContainer.insertBefore(
              notConfiguredMsg,
              document.getElementById("btn-google-login")
            );

            // Only set up guest mode button
            document
              .getElementById("btn-guest-login")
              .addEventListener("click", signInAsGuest);
            return;
          }

          // Firebase is already configured and initialized in firebase-init.js
          // Set up event listeners
          document
            .getElementById("btn-google-login")
            .addEventListener("click", signInWithGoogle);
          document
            .getElementById("btn-guest-login")
            .addEventListener("click", signInAsGuest);
          document
            .getElementById("btn-logout")
            .addEventListener("click", signOut);
          document
            .getElementById("btn-switch-to-account")
            .addEventListener("click", signInWithGoogle);
        }

        function signInWithGoogle() {
          if (!firebaseInitialized) {
            showToast(
              "Firebase tidak dikonfigurasi - login Google tidak tersedia",
              "error"
            );
            return Promise.resolve(false);
          }

          const provider = new firebase.auth.GoogleAuthProvider();

          return firebase
            .auth()
            .signInWithPopup(provider)
            .then((result) => {
              showToast("Login berhasil!", "success");
              currentUser = result.user;
              migrateLocalDataToCloud(currentUser.uid);
              return true;
            })
            .catch((error) => {
              console.error("Auth Error:", error);

              // Handle specific Firebase auth errors with helpful messages
              if (error.code === "auth/configuration-not-found") {
                showToast(
                  "Konfigurasi Firebase perlu diatur. Administrator perlu mengaktifkan Google Sign-in di Firebase Console.",
                  "error",
                  6000
                );
              } else if (error.code === "auth/unauthorized-domain") {
                showToast(
                  "Domain tidak diizinkan untuk autentikasi. Tambahkan domain ini di Firebase Console.",
                  "error",
                  6000
                );
              } else {
                showToast("Login gagal: " + error.message, "error");
              }

              return false;
            });
        }

        function signInAsGuest() {
          // Set guest mode
          localStorage.setItem("userMode", "guest");

          // Update UI for guest mode
          document
            .getElementById("account-not-logged-in")
            .classList.add("hidden");
          document.getElementById("account-logged-in").classList.add("hidden");
          document
            .getElementById("account-guest-mode")
            .classList.remove("hidden");

          // Update header auth
          updateHeaderAuth();

          showToast("Mode tamu diaktifkan", "success");

          return Promise.resolve(true);
        }

        function signOut() {
          if (!firebaseInitialized) {
            // For guest mode, just reset the state
            localStorage.removeItem("userMode");
            updateUIforLoggedOutUser();
            updateHeaderAuth();
            showToast("Berhasil keluar dari mode tamu", "success");
            return;
          }

          firebase
            .auth()
            .signOut()
            .then(() => {
              currentUser = null;
              showToast("Logout berhasil", "success");
              updateUIforLoggedOutUser();
              updateHeaderAuth();
            })
            .catch((error) => {
              showToast("Logout gagal: " + error.message, "error");
            });
        }

        // Update updateUIforLoggedInUser
        function updateUIforLoggedInUser(user) {
          // Existing code
          document.getElementById("user-avatar").src = user.photoURL || "";
          document.getElementById("user-display-name").textContent =
            user.displayName || "User";
          document.getElementById("user-email").textContent = user.email || "";

          document
            .getElementById("account-not-logged-in")
            .classList.add("hidden");
          document
            .getElementById("account-logged-in")
            .classList.remove("hidden");
          document.getElementById("account-guest-mode").classList.add("hidden");

          // Update the header auth area
          updateHeaderAuth();

          // Update localStorage
          localStorage.setItem("userMode", "account");
        }

        // Update updateUIforLoggedOutUser
        function updateUIforLoggedOutUser() {
          // Existing code
          const userMode = localStorage.getItem("userMode");

          if (userMode === "guest") {
            document
              .getElementById("account-not-logged-in")
              .classList.add("hidden");
            document
              .getElementById("account-logged-in")
              .classList.add("hidden");
            document
              .getElementById("account-guest-mode")
              .classList.remove("hidden");
          } else {
            document
              .getElementById("account-not-logged-in")
              .classList.remove("hidden");
            document
              .getElementById("account-logged-in")
              .classList.add("hidden");
            document
              .getElementById("account-guest-mode")
              .classList.add("hidden");

            localStorage.removeItem("userMode");
          }

          // Update header auth area
          updateHeaderAuth();
        }

        function updateHeaderUserInfo(user) {
          // Add a small user info display to the header or create a user menu button
          const headerUserArea = document.createElement("div");
          headerUserArea.id = "header-user-info";
          headerUserArea.className = "ml-auto flex items-center";

          if (user) {
            headerUserArea.innerHTML = `
                  <div class="flex items-center cursor-pointer" id="user-menu-trigger">
                    <img src="${
                      user.photoURL || ""
                    }" alt="Profile" class="w-8 h-8 rounded-full border border-gray-600">
                    <span class="ml-2 hidden md:block text-sm">${
                      user.displayName || "User"
                    }</span>
                  </div>
                `;
          } else {
            const userMode = localStorage.getItem("userMode");
            if (userMode === "guest") {
              headerUserArea.innerHTML = `
                    <div class="flex items-center cursor-pointer" id="user-menu-trigger">
                      <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                      </div>
                      <span class="ml-2 hidden md:block text-sm">Mode Tamu</span>
                    </div>
                  `;
            } else {
              headerUserArea.innerHTML = `
                    <button id="btn-header-login" class="text-sm bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded">
                      Masuk
                    </button>
                  `;
            }
          }

          // Find a place to add this in the header
          const headerElement = document.querySelector(
            "aside div.flex.items-center"
          );
          if (headerElement) {
            // Remove any existing user info
            const existingInfo = document.getElementById("header-user-info");
            if (existingInfo) existingInfo.remove();

            // Add new user info
            headerElement.appendChild(headerUserArea);

            // Add click event for login button if present
            const loginButton = document.getElementById("btn-header-login");
            if (loginButton) {
              loginButton.addEventListener("click", () => {
                showSettings();
              });
            }

            // Add click event for user menu if present
            const userMenuTrigger =
              document.getElementById("user-menu-trigger");
            if (userMenuTrigger) {
              userMenuTrigger.addEventListener("click", () => {
                showSettings();
              });
            }
          }
        }

        // Data migration function
        function migrateLocalDataToCloud(userId) {
          // Get all BRDs from localStorage
          const brdList = JSON.parse(localStorage.getItem("brd_list") || "[]");

          if (brdList.length === 0) return;

          const db = firebase.firestore();
          const batch = db.batch();

          // Create a reference to user's BRD collection
          const userBrdCollection = db
            .collection("users")
            .doc(userId)
            .collection("brds");

          // For each BRD, create a document in Firestore
          brdList.forEach((brd) => {
            const brdData = JSON.parse(localStorage.getItem(`brd_${brd.id}`));
            if (brdData) {
              const docRef = userBrdCollection.doc(brd.id);
              batch.set(docRef, brdData);
            }
          });

          // Commit the batch
          batch
            .commit()
            .then(() => {
              showToast("Data berhasil disinkronkan ke cloud!", "success");
            })
            .catch((error) => {
              console.error("Migration error:", error);
              showToast("Gagal sinkronisasi data: " + error.message, "error");
            });
        }

        // Settings page function
        function showSettings() {
          document.getElementById("main-menu").classList.add("hidden");
          document.getElementById("brd-list-page").classList.add("hidden");
          document.getElementById("brd-preview-page").classList.add("hidden");
          document.getElementById("wizard-container").classList.add("hidden");
          document.getElementById("settings-page").classList.remove("hidden");
        }

        // Auth modal functions
        function showAuthModal() {
          const modal = document.getElementById("auth-modal");
          if (!modal) return;

          modal.classList.remove("hidden");
          document.body.classList.add("overflow-hidden");

          // Setup event listeners
          document
            .getElementById("modal-google-login")
            .addEventListener("click", () => {
              hideAuthModal();
              signInWithGoogle().then(() => {
                if (currentUser) {
                  // If login successful, proceed to create BRD
                  setTimeout(() => {
                    currentBRDId = null;
                    showWizard();
                  }, 500);
                }
              });
            });

          document
            .getElementById("modal-guest-login")
            .addEventListener("click", () => {
              hideAuthModal();
              signInAsGuest();
              // Continue as guest
              setTimeout(() => {
                currentBRDId = null;
                showWizard();
              }, 500);
            });

          document
            .getElementById("close-auth-modal")
            .addEventListener("click", hideAuthModal);
          document
            .getElementById("auth-modal-backdrop")
            .addEventListener("click", hideAuthModal);
        }

        function hideAuthModal() {
          const modal = document.getElementById("auth-modal");
          if (!modal) return;

          modal.classList.add("hidden");
          document.body.classList.remove("overflow-hidden");
        }

        function finishBRD() {
          try {
            const data = collectAllData();

            // Save to cloud if logged in, otherwise to local storage
            const savePromise = currentUser
              ? saveBRDToCloud(data, currentBRDId)
              : Promise.resolve(saveBRD(data));

            savePromise
              .then((savedId) => {
                if (savedId) {
                  // Clear draft
                  localStorage.removeItem("brd_draft");

                  showToast("BRD berhasil disimpan!", "success");

                  setTimeout(() => {
                    showMainMenu();
                  }, 2000);
                }
              })
              .catch((error) => {
                showError(error);
              });
          } catch (error) {
            showError(error);
          }
        }
      }); // CLOSING BRACE FOR document.addEventListener
    </script>
    <!-- Auth Popup Modal -->
    <div
      id="auth-modal"
      class="fixed inset-0 flex items-center justify-center z-50 hidden"
    >
      <div
        class="fixed inset-0 bg-black opacity-50"
        id="auth-modal-backdrop"
      ></div>
      <div
        class="bg-gray-800 rounded-lg p-8 shadow-xl border border-gray-700 w-full max-w-md relative z-10"
      >
        <h2 class="text-2xl font-bold text-white mb-6 text-center">
          Mulai Membuat BRD
        </h2>

        <p class="text-gray-300 mb-6 text-center">
          Untuk membuat dan menyimpan BRD, Anda perlu masuk atau melanjutkan
          sebagai tamu.
        </p>

        <div class="flex flex-col space-y-4">
          <button
            id="modal-google-login"
            class="flex items-center justify-center bg-white hover:bg-gray-100 text-gray-800 font-bold py-3 px-4 rounded transition-colors"
          >
            <svg class="w-5 h-5 mr-3" viewBox="0 0 24 24">
              <path
                fill="#4285F4"
                d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
              />
              <path
                fill="#34A853"
                d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
              />
              <path
                fill="#FBBC05"
                d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
              />
              <path
                fill="#EA4335"
                d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
              />
            </svg>
            Masuk dengan Google
          </button>

          <div class="flex items-center my-2">
            <div class="flex-1 border-t border-gray-600"></div>
            <span class="mx-4 text-sm text-gray-500">atau</span>
            <div class="flex-1 border-t border-gray-600"></div>
          </div>

          <button
            id="modal-guest-login"
            class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded transition-colors"
          >
            Lanjutkan sebagai Tamu
          </button>

          <p class="text-xs text-gray-500 text-center mt-4">
            Mode tamu hanya menyimpan data di perangkat ini. Data bisa hilang
            jika browser dibersihkan.
          </p>
        </div>

        <button
          id="close-auth-modal"
          class="absolute top-4 right-4 text-gray-500 hover:text-white"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      </div>
    </div>
  </body>
</html>
